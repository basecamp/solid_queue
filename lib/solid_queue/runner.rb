# frozen_string_literal: true

module SolidQueue::Runner
  extend ActiveSupport::Concern

  included do
    include ActiveSupport::Callbacks
    define_callbacks :start, :stop, :run

    include SolidQueue::AppExecutor
    include ProcessRegistration
  end

  def start
    @stopping = false

    run_callbacks(:start) do
      @thread = Thread.new { start_loop }
    end

    SolidQueue.logger.info("[SolidQueue] Started #{self}")
  end

  def stop
    @stopping = true

    run_callbacks(:stop) do
      wait
    end
  end

  def running?
    !stopping?
  end

  private
    def start_loop
      loop do
        break if stopping?
        run_callbacks :run do
          run
        end
      end
    ensure
      clean_up
    end

    def run
    end

    def stopping?
      @stopping
    end

    def wait
      Thread.new { @thread&.join }.tap(&:join)
    end

    def clean_up
    end

    def interruptable_sleep(seconds)
      while !stopping? && seconds > 0
        sleep 0.1
        seconds -= 0.1
      end
    end

    def hostname
      @hostname ||= Socket.gethostname
    end

    def pid
      @pid ||= Process.pid
    end
end
